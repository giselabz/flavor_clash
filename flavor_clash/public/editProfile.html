<!DOCTYPE html>
<html lang="ca">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flavor Clash - Edita el perfil</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <form id="editProfileForm">
        <h2>Edita el perfil</h2>
        <input type="text" id="editName" placeholder="Nom" required><br>
        <label for="avatarSelect">Avatar</label><br>
        <select id="avatarSelect"></select><br>
        <label for="avatarFile">O puja una imatge</label><br>
        <input type="file" id="avatarFile" accept="image/*"><br>
        <img id="avatarPreview" src="" alt="previsualització" style="display:none;width:80px;height:80px"><br>
        <button type="submit">Desa canvis</button>
        <a href="mainMenu.html" id="cancelEdit">Cancel·la</a>
        <p id="editError" style="color:red;"></p>
    </form>

    <script type="module">
      import { requireAuth } from './session.js';
      import UserService from './api/UserService.js';
      import AvatarService from './api/AvatarService.js';
      await requireAuth();

      const form = document.getElementById('editProfileForm');
      const nameInput = document.getElementById('editName');
      const avatarSelect = document.getElementById('avatarSelect');
      const avatarFile = document.getElementById('avatarFile');
      const avatarPreview = document.getElementById('avatarPreview');
      const errorEl = document.getElementById('editError');

      const avatars = [
        { nom: 'Tomàquet', src: 'avatars/tomato_avatar.png' },
        { nom: 'Alvocat', src: 'avatars/avocado_avatar.png' },
        { nom: 'Patata', src: 'avatars/potatoe_avatar.png' },
        { nom: 'Síndria', src: 'avatars/watermelon_avatar.png' },
        { nom: 'Maduixa', src: 'avatars/strawberry_avatar.png' }
      ];
      avatars.forEach(a => {
        const opt = document.createElement('option');
        opt.value = a.src;
        opt.textContent = a.nom;
        avatarSelect.appendChild(opt);
      });

      const user = await UserService.getMyProfile().catch(() => ({}));
      nameInput.value = user.name || '';
      if (user.avatar_url && user.avatar_url.startsWith('avatars/')) {
        avatarSelect.value = user.avatar_url;
        avatarPreview.src = user.avatar_url;
        avatarPreview.style.display = 'inline';
      }

      let uploadedAvatarPath = null;
      avatarFile.addEventListener('change', async () => {
        const file = avatarFile.files[0];
        if (!file) return;
        try {
          uploadedAvatarPath = await AvatarService.uploadAvatar(file);
          const url = await AvatarService.getAvatarUrl(uploadedAvatarPath);
          avatarPreview.src = url;
          avatarPreview.style.display = 'inline';
        } catch (err) {
          console.error(err);
          errorEl.textContent = 'Error pujant l\'avatar';
        }
      });

      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        errorEl.textContent = '';
        try {
          const updates = {
            name: nameInput.value,
            avatar_url: uploadedAvatarPath ? uploadedAvatarPath : avatarSelect.value
          };
          await UserService.updateMyProfile(updates);
          location.href = 'profile.html';
        } catch (err) {
          console.error(err);
          errorEl.textContent = 'Error guardant els canvis';
        }
      });
    </script>
</body>
</html>
