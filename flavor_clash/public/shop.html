<!-- /public/shop.html -->
<!doctype html>
<html lang="ca">
<head>
  <meta charset="utf-8" />
  <title>Flavor Clash ¬∑ Tenda</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="style.css" />
  <style>
    body{font:14px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial;background:#fff8ef;}
    .wrap{max-width:980px;margin:0 auto;padding:18px}
    .grid{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
    .card{background:#fff;border:1px solid #0002;border-radius:12px;padding:12px;display:flex;flex-direction:column;gap:8px}
    .row{display:flex;gap:10px;align-items:center;justify-content:space-between}
    .btn{border:1px solid #0002;background:#fff;border-radius:10px;padding:8px 12px;cursor:pointer}
    .btn.primary{background:#ffe6c7}
    .muted{opacity:.7}
    .err{margin:10px 0;padding:10px 12px;border:1px solid #f003;background:#ffecec;color:#900;border-radius:8px;display:none}
    @media (max-width:900px){.grid{grid-template-columns:repeat(2,1fr)}}
    @media (max-width:540px){.grid{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="wrap">
    <div id="banner" class="err"></div>

    <div class="row" style="margin-bottom:12px">
      <a class="btn" href="mainMenu.html">‚Üê Men√∫</a>
      <div class="muted">Saldo: <b id="points">‚Äî</b> pts</div>
    </div>

    <h2>Cartes disponibles</h2>
    <p class="muted">Preu base: 5 pts per carta (demo).</p>
    <div id="list" class="grid"></div>
  </div>

  <script type="module">
    import { supabase } from './supabaseClient.js';
    import { requireAuth } from './session.js';
    import PurchaseService from './api/PurchaseService.js';
    import UserService from './api/UserService.js';

    const PRICE = 5;
    const $ = s=>document.querySelector(s);
    const banner = $('#banner');
    const pointsEl = $('#points');
    const listEl = $('#list');

    function showError(msg){
      banner.textContent = msg;
      banner.style.display = 'block';
      console.error(msg);
    }

    window.addEventListener('error', e => showError(e.message || 'Error de script'));
    window.addEventListener('unhandledrejection', e => showError(e.reason?.message || String(e.reason)));

    async function refreshPoints() {
      try {
        const me = await UserService.getMyProfile();
        pointsEl.textContent = me?.flavor_points ?? '0';
      } catch (e) {
        // Si falla la policy de users, que se vea claro
        showError('No s‚Äôha pogut llegir el saldo (taula users). ' + (e?.message || e));
        pointsEl.textContent = '0';
      }
    }

    function renderCard(c) {
      const el = document.createElement('div');
      el.className = 'card';
      const icon = c.icon_url
        ? `<img src="${c.icon_url}" onerror="this.style.display='none'" style="width:54px;height:54px;object-fit:cover;border-radius:10px;border:1px solid #0001;">`
        : `<div style="width:54px;height:54px;display:grid;place-items:center;border:1px solid #0001;border-radius:10px">üçΩÔ∏è</div>`;
      el.innerHTML = `
        <div class="row">
          <div style="display:flex;gap:10px;align-items:center">
            ${icon}
            <div>
              <div style="font-weight:700">${c.name}</div>
              <div class="muted" style="font-size:12px">${(c.category||[]).join(', ')}</div>
            </div>
          </div>
          <button class="btn primary" data-buy>Comprar ¬∑ ${PRICE} pts</button>
        </div>
        <div class="muted" style="font-size:12px">Sabor: ${(c.flavor||[]).join(', ')} ¬∑ Textura: ${(c.texture||[]).join(', ')}</div>
      `;
      el.querySelector('[data-buy]').onclick = async () => {
        try {
          const res = await PurchaseService.buyCard(c.id, PRICE, 1);
          alert('Comprada ‚úì  ¬∑ Punts restants: ' + (res?.remaining_points ?? '‚Äî'));
          await refreshPoints();
        } catch (e) {
          showError(e?.message || 'Error en la compra');
        }
      };
      return el;
    }

    async function init() {
      await requireAuth('login.html');

      await refreshPoints();

      const { data, error } = await supabase.from('cards').select('*').order('name');
      if (error) {
        showError('No s‚Äôhan pogut carregar les cartes (taula cards). ' + error.message);
        return;
      }
      listEl.innerHTML = '';
      data.forEach(c => listEl.appendChild(renderCard(c)));
    }
    init();
  </script>
</body>
</html>
